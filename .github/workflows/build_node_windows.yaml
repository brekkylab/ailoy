name: Prebuild Windows

on:
  push:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Enable Windows long path support
        shell: powershell
        run: |
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1
          git config --system core.longpaths true

      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install Chocolatey dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install openssl 7zip

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/buildtrees
            vcpkg/packages
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Install vcpkg and LAPACK
        shell: powershell
        run: |
          if (-not (Test-Path "vcpkg")) {
            git clone https://github.com/microsoft/vcpkg.git
          }
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg install lapack

      - name: Set BLAS/LAPACK environment variables
        shell: powershell
        run: |
          $root = "${{ github.workspace }}\vcpkg\installed\x64-windows"
          echo "BLAS_ROOT=$root" >> $env:GITHUB_ENV
          echo "LAPACK_ROOT=$root" >> $env:GITHUB_ENV
          echo "$root\bin" >> $env:GITHUB_PATH

      - name: Install Vulkan SDK
        run: |
          curl -LO https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe
          ./vulkan-sdk.exe --accept-licenses --default-answer --confirm-command install --root C:\VulkanSDK
          dir C:\VulkanSDK

      - name: Set Vulkan SDK environment
        shell: powershell
        run: |
          echo "VULKAN_SDK=C:\VulkanSDK" >> $env:GITHUB_ENV
          echo "PATH=C:\VulkanSDK\Bin;$env:PATH" >> $env:GITHUB_ENV

      - name: Install Node dependencies
        run: npm install
        working-directory: ${{ github.workspace }}/bindings/js-node

      - name: Manually run build-prebuild.js
        run: node build-prebuild.js
        working-directory: ${{ github.workspace }}/bindings/js-node
        shell: pwsh

      - name: Run prebuild script
        shell: powershell
        run: |
          npm pack
          if ($LASTEXITCODE -ne 0) {
            Write-Host "❌ npm pack failed. Showing logs:"
            Get-ChildItem -Path C:\npm\cache\_logs\*.log | Get-Content
            exit 1
          }
        working-directory: ${{ github.workspace }}/bindings/js-node

      - name: Test native addon loads
        run: node -e "require('./build/Release/ailoy_addon.node'); console.log('✅ Loaded')"

      - name: Upload Windows prebuild
        uses: actions/upload-artifact@v4
        with:
          name: prebuild-windows
          path: ${{ github.workspace }}/bindings/js-node/prebuilds/*.tar.gz
