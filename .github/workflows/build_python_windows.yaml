name: Build - Python Windows

on:
  workflow_dispatch:
    inputs:
      publish:
        type: boolean
        required: false
        description: 'Publish package to PyPI'

env:
  BUILDPACK_IMAGE: ghcr.io/brekkylab/ailoy-buildpack-windows:20251224
  PYTHON_VERSION: "3.10"
  PYTHON_FULL_VERSION: "3.10.11"

jobs:
  build:
    runs-on: windows-2022

    outputs:
      wheel_filename: ${{ steps.save_wheel_name.outputs.wheel_filename }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull buildpack image
        run: |
          docker pull ${{ env.BUILDPACK_IMAGE }}

      - name: Build package
        run: |
          $currentPath = (Get-Location).Path
          docker run --rm `
            -v "${currentPath}:C:\workspace" `
            -w "C:\workspace" `
            ${{ env.BUILDPACK_IMAGE }} `
            powershell -Command @"
              Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

              # Enable long path
              Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1
              git config --system core.longpaths true

              # Function to download files
              function Download-File {
                param([string]`$Url, [string]`$Output)
                Write-Host "Downloading `$Url to `$Output"
                try {
                  Invoke-WebRequest -Uri `$Url -OutFile `$Output -UseBasicParsing
                  Write-Host "Download completed successfully"
                } catch {
                  Write-Error "Failed to download `$Url : `$_"
                  exit 1
                }
              }

              # Create temp directory
              `$TempDir = 'C:\temp_setup'
              New-Item -ItemType Directory -Path `$TempDir -Force | Out-Null

              # =============================================
              # Install Python
              # =============================================
              Write-Host "=== Installing Python ${{ env.PYTHON_VERSION }} ==="
              `$PythonUrl = "https://www.python.org/ftp/python/${{ env.PYTHON_FULL_VERSION }}/python-${{ env.PYTHON_FULL_VERSION }}-amd64.exe"
              `$PythonInstaller = "`$TempDir\\python-installer.exe"

              Download-File -Url `$PythonUrl -Output `$PythonInstaller

              Write-Host 'Installing Python...'
              Start-Process -FilePath `$PythonInstaller -ArgumentList '/quiet', 'InstallAllUsers=1', 'PrependPath=1', 'Include_test=0', 'Include_doc=0', 'Include_dev=1', 'Include_debug=0', 'Include_launcher=1', 'InstallLauncherAllUsers=1' -Wait -NoNewWindow

              # Refresh PATH
              `$env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', 'Machine') + ';' + [System.Environment]::GetEnvironmentVariable('PATH', 'User')

              # Verify Python installation
              python --version
              if (`$LASTEXITCODE -ne 0) {
                Write-Error 'Python installation failed'
                exit 1
              }

              # Upgrade pip
              Write-Host 'Upgrading pip...'
              python -m pip install --upgrade pip

              # =============================================
              # Build ailoy-py
              # =============================================
              Write-Host '=== Build Ailoy ==='

              Set-Location 'bindings\python'

              python -m pip install maturin delvewheel

              `$env:CMAKE_BUILD_PARALLEL_LEVEL = (Get-WmiObject Win32_Processor).NumberOfLogicalProcessors
              python -m maturin build --out dist
              if (`$LASTEXITCODE -ne 0) {
                Write-Error 'python build failed'
                exit 1
              }

              `$DistWheel = Get-ChildItem dist\*.whl | Select-Object -First 1
              `$CurrentPath = (Get-Location).Path
              python -m delvewheel repair -w wheelhouse `$DistWheel --exclude vulkan-1.dll
              if (`$LASTEXITCODE -ne 0) {
                Write-Error 'delvewheel failed'
                exit 1
              }

              Write-Host '=== Build Complete ==='
          "@

      - name: Get package name
        id: save_wheel_name
        working-directory: ${{ github.workspace }}/bindings/python
        run: |
          $wheel = Get-ChildItem wheelhouse\*.whl | Select-Object -First 1
          echo "wheel_filename=$($wheel.Name)" >> $env:GITHUB_OUTPUT

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.save_wheel_name.outputs.wheel_filename }}
          path: ${{ github.workspace }}/bindings/python/wheelhouse/${{ steps.save_wheel_name.outputs.wheel_filename }}

  publish:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ inputs.publish }}
    permissions:
      id-token: write

    steps:
      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.wheel_filename }}
          path: wheelhouse

      - name: Publish wheel to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: wheelhouse
