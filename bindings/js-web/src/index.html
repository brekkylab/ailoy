<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ailoy WASM Test</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; }
        #output { width: 95%; height: 500px; border: 1px solid #ccc; padding: 10px; font-family: monospace; white-space: pre-wrap; background-color: #fff; }
    </style>
</head>
<body>
    <h1>Ailoy WASM Test</h1>
    <p>The output from the WebAssembly module will appear below. Check the browser's developer console (F12) for any additional errors.</p>
    <textarea id="output" readonly></textarea>

    <script>
        var textarea = document.getElementById('output');
        
        // The Emscripten 'Module' object allows us to hook into the execution.
        var Module = {
            // Redirect stdout and stderr from C++ to our textarea.
            print: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                textarea.value += text;
                textarea.scrollTop = textarea.scrollHeight; // Auto-scroll
            },
            printErr: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                textarea.value += "ERROR: " + text + "\n";
                textarea.scrollTop = textarea.scrollHeight; // Auto-scroll
            }
        };
    </script>
    
    <script type="module">
        import * as Ailoy from "./index.js"

        const rt = new Ailoy.Runtime();
        await rt.start();
        window.runtime = rt;

        // const agent = await Ailoy.defineAgent(rt, Ailoy.APIModel({id: "gpt-4o", apiKey: "<OPENAI_API_KEY>"}));
        const agent = await Ailoy.defineAgent(rt, Ailoy.LocalModel({id: "Qwen/Qwen3-0.6B"}));
        // await agent.addToolsFromMcpClient("test", new Ailoy.MCPStreamableHTTPClientTransport("http://localhost:8123/mcp"));
        agent.addJSFunctionTool(
            ({a, b})=> a * b,
            {
                name: "multiply",
                description: "A function that multiplies two numbers",
                parameters: {
                    type: "object",
                    properties: {
                        a: {
                            type: "number",
                            description: "The first number to multiply",
                        },
                        b: {
                            type: "number",
                            description: "The second number to multiply",
                        },
                    },
                    required: ["a", "b"],
                },
            },
        );
        agent.addJSFunctionTool(
            ({a, b})=> a / b,
            {
                name: "divide",
                description: "A function that divides a number with another number",
                parameters: {
                    type: "object",
                    properties: {
                        a: {
                            type: "number",
                            description: "The dividend number",
                        },
                        b: {
                            type: "number",
                            description: "The divisor number",
                        },
                    },
                    required: ["a", "b"],
                },
            },
        );
        // window.agent = agent;
        // console.log("READY")
        const REASONING = false;


        for await (const resp of agent.query("Calculate 13492 * 95832.", {reasoning: REASONING})) {
        // for await (const resp of agent.query("Hello, who are you?", {reasoning: REASONING})) {
            if (resp.isTypeSwitched) {
                Module.print(`\n<${resp.type}>\n`)
            }
            // Module.print(JSON.stringify(resp, null, 2));
            if (resp.type === "output_text") {
                Module.print(resp.content);
            } else if (resp.type === "reasoning") {
                Module.print(resp.content);
            } else if (resp.type === "tool_call") {
                Module.print(JSON.stringify(resp.content, null, 2)+"\n");
            } else if (resp.type === "tool_call_result") {
                Module.print(resp.content.content[0].text);
            } else
                Module.print(resp.content);
        }

        for await (const resp of agent.query("Verify '13492 * 95832 = 1292965344' with division, please", {reasoning: REASONING})) {
            if (resp.isTypeSwitched) {
                Module.print(`\n<${resp.type}>\n`)
            }
            // Module.print(JSON.stringify(resp, null, 2));
            if (resp.type === "output_text") {
                Module.print(resp.content);
            } else if (resp.type === "reasoning") {
                Module.print(resp.content);
            } else if (resp.type === "tool_call") {
                Module.print(JSON.stringify(resp.content, null, 2)+"\n");
            } else if (resp.type === "tool_call_result") {
                Module.print(resp.content.content[0].text);
            } else
                Module.print(resp.content);
        }
        window.agent = agent;

    </script>
    
</body>
</html>
