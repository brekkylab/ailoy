<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ailoy WASM Test</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; }
        #output { width: 95%; height: 500px; border: 1px solid #ccc; padding: 10px; font-family: monospace; white-space: pre-wrap; background-color: #fff; }
        #input { width: 87%; height: 50px; border: 1px}
        #enter { width: 10%; height: 50px; }
    </style>
</head>
<body>
    <h1>Ailoy WASM Test</h1>
    <p>The output from the WebAssembly module will appear below. Check the browser's developer console (F12) for any additional errors.</p>
    <textarea id="output" readonly></textarea>
    <input type="text" id="input"/>
    <input type="button" id="enter" value="Enter" onclick="query()" disabled=true/>

    <script>
        function printResp(resp) {
            if (resp.isTypeSwitched) {
                Module.print(`\n<${resp.type}>\n`)
            }
            // Module.print(JSON.stringify(resp, null, 2));
            if (resp.type === "output_text") {
                Module.print(resp.content);
            } else if (resp.type === "reasoning") {
                Module.print(resp.content);
            } else if (resp.type === "tool_call") {
                Module.print(JSON.stringify(resp.content, null, 2) + "\n");
            } else if (resp.type === "tool_call_result") {
                Module.print(resp.content.content[0].text + "\n");
            } else
                Module.print(resp.content);
        }

        var textarea = document.getElementById('output');
        
        // The Emscripten 'Module' object allows us to hook into the execution.
        var Module = {
            // Redirect stdout and stderr from C++ to our textarea.
            print: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                textarea.value += text;
                textarea.scrollTop = textarea.scrollHeight; // Auto-scroll
            },
            printErr: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                textarea.value += "ERROR: " + text + "\n";
                textarea.scrollTop = textarea.scrollHeight; // Auto-scroll
            }
        };

        var text_input = document.getElementById('input');
        text_input.addEventListener('keydown', function(event) {
            if (document.getElementById('enter').disabled === false && event.key == "Enter") {
                query();
            }
        });

        function setDisableEnter(v) {
            document.getElementById('enter').disabled = v ?? false;
        }

        async function query() {
            setDisableEnter(true);
            const agent = window.agent;
            const query = text_input.value;
            text_input.value = "";
            Module.print(`<User message>\n${query}\n`)
            for await (const resp of agent.query(query)) {
                printResp(resp);
            }
            Module.print("\n\n");
            setDisableEnter(false);
        }
    </script>
    
    <script type="module">
        import * as Ailoy from "./index.js"

        const rt = new Ailoy.Runtime();
        await rt.start();
        window.runtime = rt;

        // const agent = await Ailoy.defineAgent(rt, Ailoy.APIModel({id: "gpt-4o", apiKey: "<OPENAI_API_KEY>"}));
        const agent = await Ailoy.defineAgent(rt, Ailoy.LocalModel({id: "Qwen/Qwen3-0.6B"}));
        // await agent.addToolsFromMcpClient("test", new Ailoy.MCPStreamableHTTPClientTransport("http://localhost:8123/mcp"));

        agent.addJSFunctionTool(
            ({a, b})=> a * b,
            {
                name: "multiply",
                description: "A function that multiplies two numbers",
                parameters: {
                    type: "object",
                    properties: {
                        a: {
                            type: "number",
                            description: "The first number to multiply",
                        },
                        b: {
                            type: "number",
                            description: "The second number to multiply",
                        },
                    },
                    required: ["a", "b"],
                },
            },
        );
        agent.addJSFunctionTool(
            ({a, b})=> a / b,
            {
                name: "divide",
                description: "A function that divides a number with another number",
                parameters: {
                    type: "object",
                    properties: {
                        a: {
                            type: "number",
                            description: "The dividend number",
                        },
                        b: {
                            type: "number",
                            description: "The divisor number",
                        },
                    },
                    required: ["a", "b"],
                },
            },
        );
        // window.agent = agent;
        // console.log("READY")
        const REASONING = false;

        const query1 = "Calculate 13492 * 95832.";
        Module.print(`<User message>\n${query1}\n`)
        for await (const resp of agent.query(query1, {reasoning: REASONING})) {
            printResp(resp);
        }
        Module.print("\n\n");

        const query2 = "Verify '13492 * 95832 = 1292965344' with division, please.";
        Module.print(`<User message>\n${query2}\n`)
        for await (const resp of agent.query(query2, {reasoning: REASONING})) {
            printResp(resp);
        }
        Module.print("\n\n");

        window.agent = agent;
        setDisableEnter(false);
    </script>
    
</body>
</html>
